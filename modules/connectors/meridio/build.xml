<project default="all">

    <target name="clean">
        <delete dir="build"/>
    </target>

    <target name="calculate-condition">
        <available file="wsdls/MeridioDMWS_axis.wsdl" property="meridioDMWS_axisStatus"/>
        <available file="wsdls/MeridioRMWS_axis.wsdl" property="meridioRMWS_axisStatus"/>
        <available file="wsdls/DMDataSet.xsd" property="DMDataSetStatus"/>
        <available file="wsdls/RMDataSet.xsd" property="RMDataSetStatus"/>
        <available file="wsdls/RMClassificationDataSet.xsd" property="RMClassificationDataSetStatus"/>
        <condition property="canBuild">
            <and>
                <isset property="meridioDMWS_axisStatus"/>
                <isset property="meridioRMWS_axisStatus"/>
                <isset property="DMDataSetStatus"/>
                <isset property="RMDataSetStatus"/>
                <isset property="RMClassificationDataSetStatus"/>
            </and>
        </condition>
    </target>

    <target name="precompile-check" depends="calculate-condition" unless="canBuild">
        <echo message="Meridio Connector cannot be built without MeridioDMWS_axis.wsdl, MeridioRMWS_axis.wsdl, DMDataSet.xsd, RMDataSet.xsd, RMClassificationDataSet.xsd, activation.jar, and mailapi.jar"/>
    </target>

    <target name="classcreate-wsdl">
        <mkdir dir="build/wsdljava"/>
        <java classname="org.apache.axis.wsdl.WSDL2Java" fork="true" classpath="lib/axis.jar:lib/commons-logging.jar:lib/commons-discovery.jar:lib/saaj.jar:lib/wsdl4j.jar:lib/jaxrpc.jar:lib/activation.jar:lib/xml-apis.jar:lib/xercesImpl.jar">
            <arg value="--timeout"/>
            <arg value="0"/>
            <arg value="--noImports"/>
            <arg value="-o"/>
            <arg value="build/wsdljava"/>
            <arg value="${wsdlname}"/>
        </java>
    </target>
    
    <target name="classcreate-wsdls" depends="precompile-check" if="canBuild">
        <antcall target="classcreate-wsdl">
            <param name="wsdlname" value="wsdls/MeridioDMWS_axis.wsdl"/>
        </antcall>
        <antcall target="classcreate-wsdl">
            <param name="wsdlname" value="wsdls/MeridioRMWS_axis.wsdl"/>
        </antcall>
        <antcall target="classcreate-wsdl">
            <param name="wsdlname" value="wsdls/MetaCartaWS_axis.wsdl"/>
        </antcall>
    </target>
    
    <target name="classcreate-xsd">
        <mkdir dir="build/xsdjava"/>
        <java classname="org.exolab.castor.builder.SourceGeneratorMain" fork="true">
            <classpath>
                <fileset dir="lib">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
            <arg value="-i"/>
            <arg value="${xsdname}"/>
            <arg value="=f"/>
            <arg value="-dest"/>
            <arg value="build/xsdjava"/>
            <arg value="-package"/>
            <arg value="org.apache.lcf.crawler.connectors.meridio.${packagename}"/>
        </java>
    </target>

    <target name="classcreate-xsds" depends="precompile-check" if="canBuild">
        <mkdir dir="build/xsdjava"/>
        <antcall target="classcreate-xsd">
            <param name="xsdname" value="wsdls/DMDataSet.xsd"/>
            <param name="packagename" value="DMDataSet"/>
        </antcall>
        <antcall target="classcreate-xsd">
            <param name="xsdname" value="wsdls/RMClassificationDataSet.xsd"/>
            <param name="packagename" value="RMClassificationDataSet"/>
        </antcall>
        <antcall target="classcreate-xsd">
            <param name="xsdname" value="wsdls/RMDataSet.xsd"/>
            <param name="packagename" value="RMDataSet"/>
        </antcall>
    </target>
    
    <target name="compile-wsdls" depends="classcreate-wsdls,precompile-check" if="canBuild">
        <mkdir dir="build/wsdlclasses"/>
        <javac srcdir="build/wsdljava" destdir="build/wsdlclasses" classpath="lib/log4j-1.2.jar:lib/commons-logging.jar:lib/lcf-core.jar:lib/lcf-agents.jar:lib/lcf-pull-agent.jar:lib/mailapi.jar:lib/axis.jar:lib/activation.jar:lib/jaxrpc.jar:lib/saaj.jar" target="1.5" source="1.4"/>
    </target>

    <target name="compile-xsds" depends="classcreate-xsds,precompile-check" if="canBuild">
        <mkdir dir="build/xsdclasses"/>
        <javac srcdir="build/xsdjava" destdir="build/xsdclasses" classpath="lib/log4j-1.2.jar:lib/commons-logging.jar:lib/lcf-core.jar:lib/lcf-agents.jar:lib/lcf-pull-agent.jar:lib/mailapi.jar:lib/castor-1.0.5-commons.jar:lib/castor-1.0.5.jar:lib/castor-1.0.5-xml.jar:lib/geronimo-activation_1.1_spec.jar" target="1.5" source="1.4"/>
    </target>

    <target name="compile-connector" depends="compile-wsdls,compile-xsds,precompile-check" if="canBuild">
        <mkdir dir="build/connector/classes"/>
        <javac srcdir="connector" destdir="build/connector/classes" classpath="lib/log4j-1.2.jar:lib/commons-logging.jar:lib/commons-httpclient.jar:lib/commons-collections.jar:lib/commons-codec.jar:lib/lcf-core.jar:lib/lcf-agents.jar:lib/lcf-pull-agent.jar:lib/mailapi.jar:lib/castor-1.0.5-commons.jar:lib/castor-1.0.5.jar:lib/castor-1.0.5-xml.jar:lib/geronimo-activation_1.1_spec.jar:lib/axis.jar:build/wsdlclasses:build/xsdclasses:lib/activation.jar:lib/jaxrpc.jar:lib/saaj.jar" target="1.5" source="1.4"/>
    </target>

    <target name="compile-crawler-ui" depends="compile-connector,compile-wsdls,compile-xsds,precompile-check" if="canBuild">
        <!-- Unpack the crawler war -->
        <mkdir dir="build/crawler-war"/>
        <unwar src="war/lcf-crawler-ui.war" dest="build/crawler-war"/>
        <!-- Create a copy of everything in the proper environment -->
        <mkdir dir="build/jsp-environment/WEB-INF/lib"/>
        <mkdir dir="build/jsp-environment/WEB-INF/jsp"/>
        <copy todir="build/jsp-environment/WEB-INF" file="build/crawler-war/WEB-INF/web.xml"/>
        <copy todir="build/jsp-environment" file="build/crawler-war/adminHeaders.jsp"/>
        <copy todir="build/jsp-environment" file="build/crawler-war/adminDefaults.jsp"/>
        <copy todir="build/jsp-environment" file="build/crawler-war/error.jsp"/>
        <copy todir="build/jsp-environment" file="build/crawler-war/checkAdminLogin.jsp"/>

        <copy todir="build/jsp-environment">
            <fileset dir="crawler-ui" includes="**/*.jsp,**/*.css,**/*.png,**/*.html"/>
        </copy>
        <copy todir="build/jsp-environment/WEB-INF/lib">
            <fileset dir="build/crawler-war/WEB-INF/lib">
                <include name="*.jar"/>
            </fileset>
        </copy>
        <copy todir="build/jsp-environment/WEB-INF/jsp">
            <fileset dir="build/crawler-war/WEB-INF/jsp">
                <include name="*.tld"/>
            </fileset>
        </copy>
        <copy todir="build/jsp-environment/WEB-INF/classes">
            <fileset dir="build/connector/classes"/>
        </copy>
        <!-- Compile to java, as a check -->
        <mkdir dir="build/crawler-ui/java"/>
        <!-- Define the jsp compilation task using tomcat libraries -->
        <taskdef classname="org.apache.jasper.JspC" name="jasper2" > 
            <classpath id="jspc.classpath"> 
                <pathelement location="${java.home}/../lib/tools.jar"/>
                <fileset dir="lib"> 
                    <include name="*.jar"/> 
                </fileset> 
                <pathelement location="build/crawler-war/WEB-INF/lib/jstl.jar"/>
                <pathelement location="build/crawler-war/WEB-INF/lib/standard.jar"/>
                <pathelement location="build/connector/classes"/>
                <pathelement location="build/wsdlclasses"/>
                <pathelement location="build/xsdclasses"/>
            </classpath> 
        </taskdef> 
        <jasper2 validateXml="false" uriroot="build/jsp-environment" webXmlFragment="build/jsp-environment/WEB-INF/web-generated.xml" outputDir="build/crawler-ui/java" /> 
        <!-- Compile java classes -->
        <mkdir dir="build/crawler-ui/classes"/>
        <javac srcdir="build/crawler-ui/java" destdir="build/crawler-ui/classes" target="1.5" source="1.4">
            <classpath id="classpath">
                <pathelement location="${java.home}/../lib/tools.jar"/>
                <fileset dir="lib"> 
                    <include name="*.jar"/> 
                </fileset>
                <pathelement location="build/crawler-war/WEB-INF/lib/jstl.jar"/>
                <pathelement location="build/crawler-war/WEB-INF/lib/standard.jar"/>
                <pathelement location="build/connector/classes"/>
                <pathelement location="build/wsdlclasses"/>
                <pathelement location="build/xsdclasses"/>
            </classpath>
        </javac>
    </target>
    
    <target name="jar-connector" depends="compile-connector,precompile-check" if="canBuild">
        <mkdir dir="build/jar"/>
        <jar destfile="build/jar/lcf-meridio-connector.jar" basedir="build/connector/classes"/>
    </target>
    
    <target name="jar-wsdls" depends="compile-wsdls,precompile-check" if="canBuild">
        <mkdir dir="build/jar"/>
        <jar destfile="build/jar/lcf-meridio-wsdlstub.jar" basedir="build/wsdlclasses"/>
    </target>
    
    <target name="jar-xsds" depends="compile-xsds,precompile-check" if="canBuild">
        <mkdir dir="build/jar"/>
        <jar destfile="build/jar/lcf-meridio-xsdstub.jar" basedir="build/xsdclasses"/>
    </target>

    <target name="webapp-connector-ui" depends="compile-crawler-ui,jar-connector,jar-wsdls,jar-xsds,precompile-check" if="canBuild">
        <mkdir dir="build/webapp/crawler-ui/WEB-INF/lib"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="build/jar/lcf-meridio-connector.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="build/jar/lcf-meridio-wsdlstub.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="build/jar/lcf-meridio-xsdstub.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/axis.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/jaxrpc.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/wsdl4j.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/saaj.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/commons-discovery.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/castor-1.0.5-commons.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/castor-1.0.5.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/castor-1.0.5-xml.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/geronimo-activation_1.1_spec.jar"/>
        <copy todir="build/webapp/crawler-ui/WEB-INF/lib" file="lib/geronimo-javamail_1.4_spec.jar"/>
        <mkdir dir="build/webapp/crawler-ui"/>
        <copy todir="build/webapp/crawler-ui">
            <fileset dir="crawler-ui" includes="**/*.jsp,**/*.css,**/*.png,**/*.html"/>
        </copy>
    </target>
    
    <target name="iar-connector-ui" depends="webapp-connector-ui,precompile-check" if="canBuild">
        <mkdir dir="build/iar"/>
        <jar destfile="build/iar/lcf-meridioconnector-crawler-ui.iar" basedir="build/webapp/crawler-ui"/>
    </target>

    <target name="all" depends="jar-connector,jar-wsdls,jar-xsds,iar-connector-ui"/>
    
</project>
